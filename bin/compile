#!/bin/bash

#Params
api_key=`cat $3/API_KEY` 
api_secret=`cat $3/API_SECRET`
cc=`cat $3/CC`
name=`cat $3/NAME`

#Create Application
echo "-----> Creating New Nexmo Applicaiton"
curl -s -o /tmp/app.json https://api.nexmo.com/v1/applications -d api_key=$api_key -d api_secret=$api_secret -d name=HEROKU-$name -d type=voice -d answer_url=https://$name.herokuapp.com/ncco -d event_url=https://$name.herokuapp.com/event
app_id=`cat /tmp/app.json | python -mjson.tool | grep id | awk -F ":" {'print $2'} | awk '{print substr($0, 3, length($0) - 4)}'`
private_key=`cat /tmp/app.json | python -mjson.tool | grep private_key | awk -F ":" {'print $2'} | awk '{print substr($0, 3, length($0) - 4)}' | tr -d '\\n'`

echo $app_id
echo "-------"
echo $private_key
#Search for  and Buy a Number
echo "-----> Searching for Number in $cc"
curl -s -o /tmp/number.json -H "Accept: application/json" https://rest.nexmo.com/number/search/$api_key/$api_secret/$cc?size=1 
lvn=`cat /tmp/number.json | python -mjson.tool | grep msisdn | awk -F ":" {'print $2'} | awk '{print substr($0, 3, length($0) - 4)}'`

echo "-----> Purchasing Number: $lvn"
curl -s https://rest.nexmo.com/number/buy -d api_key=$api_key -d api_secret=$api_secret -d country=$cc -d msisdn=$lvn


#Link Number to App
echo "-----> Linking Number to Application"
curl -s  https://rest.nexmo.com/number/update -d api_key=$api_key -d api_secret=$api_secret  -d country=$cc -d msisdn=$lvn -d voiceCallbackType='app' -d voiceCallbackValue=$app_id



echo "-----> Setting Env Vars"
touch $1/.env
echo "MY_LVN=$lvn" >> $1/.env
echo "APP_ID=$app_id" >> $1/.env
echo "PRIVATE_KEY='$private_key'" >> $1/.env

echo "-----> Adding .profile.d script"
curl -s -o $1/.profile.d/nexmo_env_setup.sh https://raw.githubusercontent.com/nexmo-community/heroku-buildpack-voice/master/nexmo_env_setup.sh



echo "\n"
echo "      Nexmo Setup COMPLETE Your Number is: $lvn"
echo "\n"
